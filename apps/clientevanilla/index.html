<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Ejemplo VR Paisaje - Rulocode</title>
    <meta name="description" content="Ejemplo simple de VR con paisaje usando A-Frame y assets locales">
    <script src="aframe-v1.3.0.min.js"></script>
    <script src="scenes-config.js"></script>
    <script src="websocket-client.js"></script>
    <style>
      body { margin: 0; }
      .a-loader-title { font-family: sans-serif; }
      #clock-html {
        position: fixed;
        top: 20px;
        right: 40px;
        background: rgba(30,30,30,0.7);
        color: #FFD700;
        font-family: monospace;
        font-size: 2.2em;
        padding: 0.2em 0.7em;
        border-radius: 0.5em;
        z-index: 1000;
        letter-spacing: 0.1em;
        box-shadow: 0 2px 8px #0008;
      }
    </style>
  </head>
  <body>
    <div id="clock-html">08:00</div>
    <a-scene background="color: #88c">
      <!-- Audio y assets - Dynamic loading -->
      <a-assets>
        <audio id="current-audio" src="audio/ambient-wind.mp3"></audio>
        <img id="current-skybox" src="panos/cpf_florena.jpg">
        <img id="grass-texture" src="images/grass.jpg">
        <a-asset-item id="tree-model" src="models/OakTree.gltf"></a-asset-item>
      </a-assets>

      <!-- Scene loading overlay -->
      <a-entity id="scene-overlay"
                geometry="primitive: plane; width: 10; height: 6"
                material="color: black; opacity: 0"
                position="0 0 -2"
                visible="false">
        <a-text value="Loading Scene..."
                position="0 0 0.01"
                align="center"
                color="white"
                scale="2 2 2"></a-text>
      </a-entity>

      <!-- Audio component -->
      <a-sound id="scene-sound"
               src="#current-audio"
               autoplay="true"
               loop="true"
               volume="0.5"></a-sound>

      <!-- Skybox esférico -->
      <a-sky id="scene-skybox"
             src="#current-skybox"
             rotation="0 -90 0"></a-sky>

      <!-- Lighting system -->
      <a-entity id="ambient-light"
                light="type: ambient; color: #ffffff; intensity: 0.7"></a-entity>

      <a-entity id="directional-light"
                light="type: directional; color: #ffeeaa; intensity: 0.8"
                position="0 1 1"></a-entity>

      <!-- Ground plane -->
      <a-plane id="scene-ground"
               src="#grass-texture"
               rotation="-90 0 0"
               width="40"
               height="40"
               repeat="10 10"
               material="repeat: 10 10"></a-plane>

      <!-- 3D Models container -->
      <a-entity id="scene-models">
        <a-entity id="oak-tree"
                  gltf-model="#tree-model"
                  position="0 0 -5"
                  scale="2 2 2"></a-entity>
      </a-entity>

      <!-- Cámara y controles VR -->
      <a-entity camera look-controls wasd-controls position="0 1.6 5"></a-entity>

      <script>
        // VR Scene Management System
        let hora = 8, minuto = 0;
        let esDia = true;
        let vrClient = null;
        let currentSceneId = 'escena1'; // Default scene
        let sceneManager = null;

        // Scene Manager Class
        class VRSceneManager {
          constructor() {
            this.currentScene = null;
            this.isLoading = false;
            this.elements = {};
            this.initializeElements();
          }

          initializeElements() {
            this.elements = {
              skybox: document.querySelector('#scene-skybox'),
              sound: document.querySelector('#scene-sound'),
              ambientLight: document.querySelector('#ambient-light'),
              directionalLight: document.querySelector('#directional-light'),
              ground: document.querySelector('#scene-ground'),
              models: document.querySelector('#scene-models'),
              overlay: document.querySelector('#scene-overlay'),
              assets: {
                audio: document.querySelector('#current-audio'),
                skybox: document.querySelector('#current-skybox')
              }
            };
          }

          async loadScene(sceneId) {
            console.log('🔍 loadScene called with:', sceneId);
            console.log('🔍 Available scenes:', Object.keys(SCENES_CONFIG));
            console.log('🔍 Scene exists?', !!SCENES_CONFIG[sceneId]);

            if (this.isLoading) {
              console.warn('⚠️ Scene loading already in progress');
              return false;
            }

            if (!SCENES_CONFIG[sceneId]) {
              console.error('❌ Scene not found:', sceneId);
              console.log('Available scenes:', Object.keys(SCENES_CONFIG));
              return false;
            }

            console.log('🎬 Loading scene:', sceneId);
            this.isLoading = true;
            this.showLoadingOverlay();

            const sceneConfig = SCENES_CONFIG[sceneId];

            try {
              // Update assets
              await this.updateAssets(sceneConfig);

              // Update scene elements
              this.updateSkybox(sceneConfig);
              this.updateLighting(sceneConfig);
              this.updateModels(sceneConfig);
              this.updateAudio(sceneConfig);

              this.currentScene = sceneConfig;
              currentSceneId = sceneId;

              console.log('✅ Scene loaded successfully:', sceneId);

              // Notify server we're ready
              if (vrClient && vrClient.isConnected) {
                vrClient.sendReady(sceneId);
              }

              return true;
            } catch (error) {
              console.error('❌ Error loading scene:', error);
              return false;
            } finally {
              this.isLoading = false;
              this.hideLoadingOverlay();
            }
          }

          async updateAssets(sceneConfig) {
            // Update audio asset
            this.elements.assets.audio.setAttribute('src', sceneConfig.assets.audio);

            // Update skybox asset
            this.elements.assets.skybox.setAttribute('src', sceneConfig.assets.skybox);

            // Wait for assets to load
            return new Promise(resolve => setTimeout(resolve, 500));
          }

          updateSkybox(sceneConfig) {
            this.elements.skybox.setAttribute('src', '#current-skybox');
          }

          updateLighting(sceneConfig) {
            const { ambient, directional } = sceneConfig.lighting;

            this.elements.ambientLight.setAttribute('light', {
              type: 'ambient',
              color: ambient.color,
              intensity: ambient.intensity
            });

            this.elements.directionalLight.setAttribute('light', {
              type: 'directional',
              color: directional.color,
              intensity: directional.intensity
            });
          }

          updateModels(sceneConfig) {
            // Clear existing models
            this.elements.models.innerHTML = '';

            // Add models from config
            sceneConfig.assets.models.forEach(model => {
              const modelEntity = document.createElement('a-entity');
              modelEntity.setAttribute('id', model.id);
              modelEntity.setAttribute('gltf-model', '#tree-model');
              modelEntity.setAttribute('position', model.position);
              modelEntity.setAttribute('scale', model.scale);
              this.elements.models.appendChild(modelEntity);
            });
          }

          updateAudio(sceneConfig) {
            this.elements.sound.setAttribute('src', '#current-audio');
          }

          showLoadingOverlay() {
            this.elements.overlay.setAttribute('visible', 'true');
            this.elements.overlay.setAttribute('material', 'opacity', 0.8);
          }

          hideLoadingOverlay() {
            this.elements.overlay.setAttribute('visible', 'false');
            this.elements.overlay.setAttribute('material', 'opacity', 0);
          }
        }

        // Initialize WebSocket client after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
          const clockHtml = document.getElementById('clock-html');

          // Initialize Scene Manager
          sceneManager = new VRSceneManager();

          // Initialize WebSocket client
          vrClient = new VRWebSocketClient({
            serverUrl: 'wss://192.168.40.31:8081/ws',
            deviceId: `clientevanilla-${Date.now()}`,
            onConnect: () => {
              console.log('🎮 VR Client connected to server');
              // Send ready signal for current scene
              setTimeout(() => vrClient.sendReady(currentSceneId), 1000);
            },
            onDisconnect: () => {
              console.log('🔌 VR Client disconnected from server');
            },
            onCommand: (command) => {
              handleServerCommand(command);
            },
            onError: (error) => {
              console.error('🚨 VR Client error:', error);
            }
          });

          // Connect to server
          vrClient.connect();

          function pad(n) { return n < 10 ? '0'+n : n; }

          function actualizarReloj() {
            clockHtml.textContent = pad(hora) + ':' + pad(minuto);
          }

          function actualizarClima() {
            // Día: 07:00 a 19:00
            const horaNum = hora + minuto/60;
            const nuevoEsDia = (horaNum >= 7 && horaNum < 19);

            if (nuevoEsDia !== esDia) {
              esDia = nuevoEsDia;

              // Automatically switch scenes based on time of day
              if (sceneManager) {
                if (esDia) {
                  console.log('☀️ Switching to day scene (escena1)');
                  sceneManager.loadScene('escena1');
                } else {
                  console.log('🌙 Switching to night scene (escena2)');
                  sceneManager.loadScene('escena2');
                }
              }
            }

            // Send state update to server
            if (vrClient && vrClient.isConnected) {
              vrClient.sendState(currentSceneId, horaNum, true, 100);
            }
          }

          function avanzarTiempo() {
            minuto++;
            if (minuto >= 60) { minuto = 0; hora++; }
            if (hora >= 24) { hora = 0; }
            actualizarReloj();
            actualizarClima();
          }

          function handleServerCommand(command) {
            console.log('📢 Processing server command:', command);

            switch(command.commandType) {
              case 'LOAD':
                const newSceneId = command.sceneId;
                console.log('🎬 Loading scene from server:', newSceneId);
                console.log('🔍 Scene manager exists?', !!sceneManager);

                // Load the scene using scene manager
                if (sceneManager) {
                  console.log('🚀 Calling sceneManager.loadScene with:', newSceneId);
                  sceneManager.loadScene(newSceneId).then(success => {
                    if (success) {
                      console.log('✅ Scene loaded successfully from dashboard');
                    } else {
                      console.error('❌ Failed to load scene from dashboard');
                    }
                  }).catch(error => {
                    console.error('💥 Error in loadScene promise:', error);
                  });
                } else {
                  console.error('❌ Scene manager not initialized');
                }
                break;

              case 'START_AT':
                const targetTime = command.epochMs;
                const currentTime = vrClient.getServerTime();
                console.log('▶️ Start at:', new Date(targetTime), 'Current:', new Date(currentTime));

                // Sync timeline to target time
                const timeDiff = targetTime - currentTime;
                if (Math.abs(timeDiff) > 1000) { // If more than 1 second difference
                  console.log('⏰ Syncing timeline, difference:', timeDiff, 'ms');
                  // You could adjust hora/minuto here based on the time difference
                }
                break;

              case 'PAUSE':
                console.log('⏸️ Pausing experience');
                // Pause audio and timeline
                const audioEl = document.querySelector('#scene-sound');
                if (audioEl) {
                  audioEl.components.sound.pauseSound();
                }
                break;

              case 'RESUME':
                console.log('▶️ Resuming experience');
                // Resume audio and timeline
                const resumeAudioEl = document.querySelector('#scene-sound');
                if (resumeAudioEl) {
                  resumeAudioEl.components.sound.playSound();
                }
                break;

              case 'SEEK':
                const deltaMs = command.deltaMs;
                console.log('⏭️ Seeking by:', deltaMs, 'ms');
                // Adjust timeline by deltaMs
                const deltaMinutes = deltaMs / 60000; // Convert to virtual minutes
                minuto += Math.round(deltaMinutes);
                if (minuto >= 60) {
                  hora += Math.floor(minuto / 60);
                  minuto = minuto % 60;
                }
                if (minuto < 0) {
                  hora -= Math.ceil(Math.abs(minuto) / 60);
                  minuto = 60 + (minuto % 60);
                }
                if (hora >= 24) hora = hora % 24;
                if (hora < 0) hora = 24 + (hora % 24);
                actualizarReloj();
                actualizarClima();
                break;

              default:
                console.log('🤷 Unknown command:', command.commandType);
            }
          }

          actualizarReloj();
          setInterval(avanzarTiempo, 1000); // 1 seg real = 1 min virtual

          // Expose to global scope for debugging
          window.vrClient = vrClient;
          window.sceneManager = sceneManager;
          window.handleServerCommand = handleServerCommand;
          window.SCENES_CONFIG = SCENES_CONFIG;

          // Test scene loading functions for development
          window.loadScene = (sceneId) => {
            if (sceneManager) {
              return sceneManager.loadScene(sceneId);
            } else {
              console.error('Scene manager not initialized');
              return false;
            }
          };

          // Time control functions for demonstration
          window.setTime = (newHora, newMinuto = 0) => {
            hora = newHora;
            minuto = newMinuto;
            actualizarReloj();
            actualizarClima();
            console.log(`⏰ Time set to ${pad(hora)}:${pad(minuto)}`);
          };

          window.skipToNight = () => window.setTime(20, 0); // 8:00 PM
          window.skipToDay = () => window.setTime(8, 0);   // 8:00 AM

          console.log('🎮 VR Scene Controls Available:');
          console.log('  loadScene("escena1") - Load day scene');
          console.log('  loadScene("escena2") - Load night scene');
          console.log('  setTime(hour, minute) - Set virtual time');
          console.log('  skipToDay() - Jump to 8:00 AM');
          console.log('  skipToNight() - Jump to 8:00 PM');
        });
      </script>
    </a-scene>
  </body>
</html>