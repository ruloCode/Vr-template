<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Ejemplo VR Paisaje - Rulocode</title>
    <meta
      name="description"
      content="Ejemplo simple de VR con paisaje usando A-Frame y assets locales"
    />
    <script src="aframe-v1.3.0.min.js"></script>
    <script src="scenes-config.js"></script>
    <script src="websocket-client.js"></script>
    <style>
      body {
        margin: 0;
      }
      .a-loader-title {
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <a-scene background="color: #88c">
      <!-- Audio y assets - Dynamic loading -->
      <a-assets>
        <audio id="current-audio" src="audio/ambient-wind.mp3"></audio>
        <img id="current-skybox" src="images/base.jpg" />

        <!-- Solar videos for floating screen (Scene 1 only) -->
        <video
          id="solar-1-video"
          src="videos/solar_1.MP4"
          preload="metadata"
          loop="false"
          crossorigin="anonymous"
          muted
        ></video>
        <video
          id="solar-2-video"
          src="videos/solar_2.MP4"
          preload="metadata"
          loop="false"
          crossorigin="anonymous"
          muted
        ></video>
        <video
          id="solar-3-video"
          src="videos/solar_3.MP4"
          preload="metadata"
          loop="false"
          crossorigin="anonymous"
          muted
        ></video>

        <!-- Petroleo images for floating screen (Scene 2 only) -->
        <img id="petroleo-1-image" src="images/petroleo_1.jpg" />
        <img id="petroleo-2-image" src="images/petroleo_2.jpg" />
        <img id="petroleo-3-image" src="images/petroleo_3.jpg" />

        <!-- Plataforma images for floating screen (Scene 3 only) -->
        <img id="plataforma-1-image" src="images/plataforma_1.jpg" />
        <img id="plataforma-2-image" src="images/plataforma_2.jpg" />
        <img id="plataforma-3-image" src="images/plataforma_3.jpg" />

        <!-- CPF images for floating screen (Scene 3 only) -->
        <img id="cpf-cupiagua-image" src="images/cpf_cupiagua.jpg" />
        <img id="cpf_cusiana-image" src="images/cpf_cusiana.jpg" />
        <img id="cpf_florena-image" src="images/cpf_florena.jpg" />
      </a-assets>

      <!-- Scene loading overlay -->
      <a-entity
        id="scene-overlay"
        geometry="primitive: plane; width: 10; height: 6"
        material="color: black; opacity: 0"
        position="0 0 -2"
        visible="false"
      >
        <a-text
          value="Loading Scene..."
          position="0 0 0.01"
          align="center"
          color="white"
          scale="2 2 2"
        ></a-text>
      </a-entity>

      <!-- Audio component -->
      <a-sound
        id="scene-sound"
        src="#current-audio"
        autoplay="true"
        loop="true"
        volume="0.5"
      ></a-sound>

      <!-- Skybox esfÃ©rico -->
      <a-sky id="scene-skybox" src="#current-skybox" rotation="0 -90 0"></a-sky>

      <!-- Single floating screen that cycles through solar videos (Scene 1 only) -->
      <a-plane
        id="park-screen"
        src="#solar-1-video"
        position="-50 55 20"
        rotation="-30 -87 0"
        width="100"
        height="50"
        material="shader: flat; side: double"
        visible="false"
        solar-video-cycler
      ></a-plane>

      <!-- Single floating screen that cycles through petroleo images (Scene 2 only) -->
      <a-plane
        id="petroleo-screen"
        src="#petroleo-2-image"
        position="0 150 150"
        rotation="-30 0 0"
        width="180"
        height="100"
        material="shader: flat; side: double"
        visible="false"
        petroleo-image-cycler
      ></a-plane>

      <!-- Single floating screen that cycles through plataforma images (Scene 3 only) -->
      <a-plane
        id="plataforma-screen"
        src="#plataforma-1-image"
        position="-200 100 0"
        rotation="30 100 0"
        width="180"
        height="100"
        material="shader: flat; side: double"
        visible="false"
        plataforma-image-cycler
      ></a-plane>

      <a-plane
        id="cpf-screen"
        src="#cpf-cupiagua-image"
        position="150 140 100"
        rotation="-30 80 0"
        width="180"
        height="100"
        material="shader: flat; side: double"
        visible="false"
        cpf-image-cycler
      ></a-plane>

      <!-- Lighting system -->
      <a-entity
        id="ambient-light"
        light="type: ambient; color: #ffffff; intensity: 0.7"
      ></a-entity>

      <a-entity
        id="directional-light"
        light="type: directional; color: #ffeeaa; intensity: 0.8"
        position="0 1 1"
      ></a-entity>

      <!-- 3D Models container (empty for clean 360Â° view) -->
      <a-entity id="scene-models">
        <!-- Models will be loaded dynamically from scene config -->
      </a-entity>

      <!-- CÃ¡mara y controles VR -->
      <a-entity
        camera
        look-controls
        wasd-controls
        position="0 1.6 5"
      ></a-entity>

      <script>
        // VR Scene Management System
        let vrClient = null;
        let currentSceneId = "base"; // Default scene
        let sceneManager = null;
        let audioEnabled = false; // Track if audio has been enabled by user interaction

        // Petroleo image cycler component for automatic image cycling
        AFRAME.registerComponent("petroleo-image-cycler", {
          init() {
            this.isVisible = false;
            this.currentImageIndex = 0;
            this.images = [
              "#petroleo-1-image",
              "#petroleo-2-image",
              "#petroleo-3-image",
            ];
            this.cycleInterval = null;

            this.show = () => {
              this.el.setAttribute("visible", "true");
              this.isVisible = true;
              this.startImageCycling();
            };

            this.hide = () => {
              this.el.setAttribute("visible", "false");
              this.isVisible = false;
              this.stopImageCycling();
            };

            this.startImageCycling = () => {
              this.showCurrentImage();
              this.cycleInterval = setInterval(() => {
                this.nextImage();
              }, 3000); // Cambiar imagen cada 3 segundos
            };

            this.stopImageCycling = () => {
              if (this.cycleInterval) {
                clearInterval(this.cycleInterval);
                this.cycleInterval = null;
              }
            };

            this.showCurrentImage = () => {
              const imageSrc = this.images[this.currentImageIndex];
              this.el.setAttribute("src", imageSrc);
            };

            this.nextImage = () => {
              this.currentImageIndex =
                (this.currentImageIndex + 1) % this.images.length;
              this.showCurrentImage();
            };

            this.setImage = (index) => {
              if (index >= 0 && index < this.images.length) {
                this.currentImageIndex = index;
                this.showCurrentImage();
              }
            };

            // Expose methods globally for easy access
            window.petroleoImageCycler = this;
          },

          remove() {
            this.stopImageCycling();
          },
        });

        // Plataforma image cycler component for automatic image cycling
        AFRAME.registerComponent("plataforma-image-cycler", {
          init() {
            this.isVisible = false;
            this.currentImageIndex = 0;
            this.images = [
              "#plataforma-1-image",
              "#plataforma-2-image",
              "#plataforma-3-image",
            ];
            this.cycleInterval = null;

            this.show = () => {
              this.el.setAttribute("visible", "true");
              this.isVisible = true;
              this.startImageCycling();
            };

            this.hide = () => {
              this.el.setAttribute("visible", "false");
              this.isVisible = false;
              this.stopImageCycling();
            };

            this.startImageCycling = () => {
              this.showCurrentImage();
              this.cycleInterval = setInterval(() => {
                this.nextImage();
              }, 3000); // Cambiar imagen cada 3 segundos
            };

            this.stopImageCycling = () => {
              if (this.cycleInterval) {
                clearInterval(this.cycleInterval);
                this.cycleInterval = null;
              }
            };

            this.showCurrentImage = () => {
              const imageSrc = this.images[this.currentImageIndex];
              this.el.setAttribute("src", imageSrc);
            };

            this.nextImage = () => {
              this.currentImageIndex =
                (this.currentImageIndex + 1) % this.images.length;
              this.showCurrentImage();
            };

            this.setImage = (index) => {
              if (index >= 0 && index < this.images.length) {
                this.currentImageIndex = index;
                this.showCurrentImage();
              }
            };

            // Expose methods globally for easy access
            window.plataformaImageCycler = this;
          },

          remove() {
            this.stopImageCycling();
          },
        });

        // CPF image cycler component for automatic image cycling
        AFRAME.registerComponent("cpf-image-cycler", {
          init() {
            this.isVisible = false;
            this.currentImageIndex = 0;
            this.images = [
              "#cpf-cupiagua-image",
              "#cpf_cusiana-image",
              "#cpf_florena-image",
            ];
            this.cycleInterval = null;

            this.show = () => {
              this.el.setAttribute("visible", "true");
              this.isVisible = true;
              this.startImageCycling();
            };

            this.hide = () => {
              this.el.setAttribute("visible", "false");
              this.isVisible = false;
              this.stopImageCycling();
            };

            this.startImageCycling = () => {
              this.showCurrentImage();
              this.cycleInterval = setInterval(() => {
                this.nextImage();
              }, 3000); // Cambiar imagen cada 3 segundos
            };

            this.stopImageCycling = () => {
              if (this.cycleInterval) {
                clearInterval(this.cycleInterval);
                this.cycleInterval = null;
              }
            };

            this.showCurrentImage = () => {
              const imageSrc = this.images[this.currentImageIndex];
              this.el.setAttribute("src", imageSrc);
            };

            this.nextImage = () => {
              this.currentImageIndex =
                (this.currentImageIndex + 1) % this.images.length;
              this.showCurrentImage();
            };

            this.setImage = (index) => {
              if (index >= 0 && index < this.images.length) {
                this.currentImageIndex = index;
                this.showCurrentImage();
              }
            };

            // Expose methods globally for easy access
            window.cpfImageCycler = this;
          },

          remove() {
            this.stopImageCycling();
          },
        });

        // Solar video cycler component for automatic video cycling
        AFRAME.registerComponent("solar-video-cycler", {
          init() {
            this.isVisible = false;
            this.currentVideoIndex = 0;
            this.videos = [
              "#solar-1-video",
              "#solar-2-video",
              "#solar-3-video",
            ];
            this.currentVideo = null;

            this.show = () => {
              this.el.setAttribute("visible", "true");
              this.isVisible = true;
              // Small delay to ensure videos are loaded
              setTimeout(() => {
                this.startVideoPlayback();
              }, 500);
            };

            this.hide = () => {
              this.el.setAttribute("visible", "false");
              this.isVisible = false;
              this.stopVideoPlayback();
            };

            this.startVideoPlayback = () => {
              this.playCurrentVideo();
            };

            this.stopVideoPlayback = () => {
              if (this.currentVideo) {
                this.currentVideo.pause();
                this.currentVideo.currentTime = 0;
              }
            };

            this.playCurrentVideo = () => {
              const videoSrc = this.videos[this.currentVideoIndex];
              this.el.setAttribute("src", videoSrc);

              // Get the video element and set up event listeners
              this.currentVideo = document.querySelector(videoSrc);
              if (this.currentVideo) {
                // Remove any existing event listeners
                this.currentVideo.removeEventListener(
                  "ended",
                  this.onVideoEnded
                );

                // Add new event listener
                this.onVideoEnded = () => {
                  this.nextVideo();
                };
                this.currentVideo.addEventListener("ended", this.onVideoEnded);

                // Wait for video to be ready before playing
                const playVideo = () => {
                  this.currentVideo.currentTime = 0;
                  this.currentVideo.play().catch((error) => {
                    console.warn(
                      "âš ï¸ No se pudo reproducir video solar:",
                      error
                    );
                    // Try to load the video again
                    this.currentVideo.load();
                    setTimeout(() => {
                      this.currentVideo.play().catch((retryError) => {
                        console.warn("âš ï¸ Segundo intento fallido:", retryError);
                      });
                    }, 1000);
                  });
                };

                // Check if video is ready
                if (this.currentVideo.readyState >= 2) {
                  playVideo();
                } else {
                  this.currentVideo.addEventListener("canplay", playVideo, {
                    once: true,
                  });
                  this.currentVideo.load();
                }
              } else {
                console.warn("âš ï¸ Video element not found:", videoSrc);
              }
            };

            this.nextVideo = () => {
              this.currentVideoIndex =
                (this.currentVideoIndex + 1) % this.videos.length;
              this.playCurrentVideo();
            };

            this.setVideo = (index) => {
              if (index >= 0 && index < this.videos.length) {
                this.currentVideoIndex = index;
                this.playCurrentVideo();
              }
            };

            // Expose methods globally for easy access
            window.solarVideoCycler = this;
          },

          remove() {
            if (this.currentVideo && this.onVideoEnded) {
              this.currentVideo.removeEventListener("ended", this.onVideoEnded);
            }
          },
        });

        // Audio initialization function
        function enableAudio() {
          if (audioEnabled) return Promise.resolve();

          return new Promise((resolve) => {
            try {
              const audioElement = document.querySelector("#current-audio");
              const soundComponent = document.querySelector("#scene-sound");

              if (audioElement && soundComponent) {
                // Try to play and immediately pause to unlock audio context
                audioElement.play()
                  .then(() => {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                    audioEnabled = true;
                    console.log("ðŸ”Š Audio context enabled");
                    resolve();
                  })
                  .catch((error) => {
                    console.warn("âš ï¸ Could not enable audio:", error);
                    audioEnabled = false;
                    resolve(); // Still resolve to continue
                  });
              } else {
                console.warn("âš ï¸ Audio elements not found");
                resolve();
              }
            } catch (error) {
              console.error("âŒ Error enabling audio:", error);
              resolve();
            }
          });
        }

        // Scene Manager Class
        class VRSceneManager {
          constructor() {
            this.currentScene = null;
            this.isLoading = false;
            this.elements = {};
            this.initializeElements();
          }

          initializeElements() {
            this.elements = {
              skybox: document.querySelector("#scene-skybox"),
              sound: document.querySelector("#scene-sound"),
              ambientLight: document.querySelector("#ambient-light"),
              directionalLight: document.querySelector("#directional-light"),
              models: document.querySelector("#scene-models"),
              overlay: document.querySelector("#scene-overlay"),
              parkScreen: document.querySelector("#park-screen"),
              petroleoScreen: document.querySelector("#petroleo-screen"),
              plataformaScreen: document.querySelector("#plataforma-screen"),
              cpfScreen: document.querySelector("#cpf-screen"),
              assets: {
                audio: document.querySelector("#current-audio"),
                skybox: document.querySelector("#current-skybox"),
              },
            };
          }

          async loadScene(sceneId) {
            if (this.isLoading) {
              console.warn("âš ï¸ Carga de escena ya en progreso");
              return false;
            }

            if (!SCENES_CONFIG[sceneId]) {
              console.error("âŒ Escena no encontrada:", sceneId);
              console.log("Escenas disponibles:", Object.keys(SCENES_CONFIG));
              return false;
            }

            console.log("ðŸŽ¬ Cargando escena:", sceneId);
            this.isLoading = true;
            this.showLoadingOverlay();

            const sceneConfig = SCENES_CONFIG[sceneId];

            try {
              // Enable audio if not already enabled
              await enableAudio();

              // Update assets
              await this.updateAssets(sceneConfig);

              // Update scene elements
              this.updateSkybox(sceneConfig);
              this.updateLighting(sceneConfig);
              this.updateModels(sceneConfig);
              this.updateAudio(sceneConfig);
              this.updateFloatingScreens(sceneConfig);

              this.currentScene = sceneConfig;
              currentSceneId = sceneId;

              console.log("âœ… Escena cargada exitosamente:", sceneId);

              // Notify server we're ready
              if (vrClient && vrClient.isConnected) {
                vrClient.sendReady(sceneId);
              }

              return true;
            } catch (error) {
              console.error("âŒ Error al cargar escena:", error);
              return false;
            } finally {
              this.isLoading = false;
              this.hideLoadingOverlay();
            }
          }

          async updateAssets(sceneConfig) {
            // Update audio asset
            this.elements.assets.audio.setAttribute(
              "src",
              sceneConfig.assets.audio
            );

            // Update skybox asset
            this.elements.assets.skybox.setAttribute(
              "src",
              sceneConfig.assets.skybox
            );

            // Wait for assets to load
            return new Promise((resolve) => setTimeout(resolve, 500));
          }

          updateSkybox(sceneConfig) {
            // Force A-Frame to reload the texture by temporarily removing and re-adding the src
            this.elements.skybox.removeAttribute("src");

            // Use a small delay to ensure the removal is processed
            setTimeout(() => {
              this.elements.skybox.setAttribute("src", "#current-skybox");
            }, 100);
          }

          updateLighting(sceneConfig) {
            const { ambient, directional } = sceneConfig.lighting;

            this.elements.ambientLight.setAttribute("light", {
              type: "ambient",
              color: ambient.color,
              intensity: ambient.intensity,
            });

            this.elements.directionalLight.setAttribute("light", {
              type: "directional",
              color: directional.color,
              intensity: directional.intensity,
            });
          }

          updateModels(sceneConfig) {
            // Clear existing models
            this.elements.models.innerHTML = "";

            // Add models from config if any
            if (
              sceneConfig.assets.models &&
              sceneConfig.assets.models.length > 0
            ) {
              sceneConfig.assets.models.forEach((model) => {
                const modelEntity = document.createElement("a-entity");
                modelEntity.setAttribute("id", model.id);
                if (model.gltfModel) {
                  modelEntity.setAttribute("gltf-model", model.gltfModel);
                }
                modelEntity.setAttribute("position", model.position || "0 0 0");
                modelEntity.setAttribute("scale", model.scale || "1 1 1");
                this.elements.models.appendChild(modelEntity);
              });
            }
          }

          updateAudio(sceneConfig) {
            // Update the audio source
            this.elements.sound.setAttribute("src", "#current-audio");

            // Only attempt to play if audio is enabled
            if (!audioEnabled) {
              console.log("ðŸ”‡ Audio not enabled yet, will play when user interacts");
              return;
            }

            // Force audio to reload and play
            setTimeout(() => {
              try {
                const audioComponent = this.elements.sound.components.sound;
                if (audioComponent) {
                  // Stop current audio if playing
                  audioComponent.stopSound();

                  // Small delay to ensure the asset is loaded
                  setTimeout(() => {
                    // Start playing the new audio
                    audioComponent.playSound();
                    console.log("ðŸ”Š Audio started for scene:", sceneConfig.id, "- Audio file:", sceneConfig.assets.audio);
                  }, 200);
                } else {
                  console.warn("âš ï¸ Audio component not found");
                }
              } catch (error) {
                console.error("âŒ Error playing audio:", error);
                // Fallback: try to play directly from the audio element
                try {
                  const audioElement = document.querySelector("#current-audio");
                  if (audioElement) {
                    audioElement.currentTime = 0;
                    audioElement.play().catch(playError => {
                      console.warn("âš ï¸ Direct audio play failed:", playError);
                    });
                  }
                } catch (fallbackError) {
                  console.error("âŒ Fallback audio play failed:", fallbackError);
                }
              }
            }, 100);
          }

          updateFloatingScreens(sceneConfig) {
            // Show/hide floating screens based on scene
            if (sceneConfig.id === "escena-1") {
              this.showParkScreen();
              this.hidePetroleoScreen();
              this.hidePlataformaScreen();
              this.hideCpfScreen();
            } else if (sceneConfig.id === "escena-2") {
              this.hideParkScreen();
              this.showPetroleoScreen();
              this.hidePlataformaScreen();
              this.hideCpfScreen();
            } else if (sceneConfig.id === "escena-3") {
              this.hideParkScreen();
              this.hidePetroleoScreen();
              this.showPlataformaScreen();
              this.showCpfScreen();
            } else {
              this.hideParkScreen();
              this.hidePetroleoScreen();
              this.hidePlataformaScreen();
              this.hideCpfScreen();
            }
          }

          showParkScreen() {
            if (!this.elements.parkScreen) {
              console.warn("âš ï¸ Referencia de pantalla solar no disponible");
              return;
            }

            try {
              const component =
                this.elements.parkScreen.components["solar-video-cycler"];
              if (component && component.show) {
                component.show();
              } else {
                this.elements.parkScreen.setAttribute("visible", "true");
              }
            } catch (error) {
              console.error("âŒ Error mostrando pantalla solar:", error);
            }
          }

          hideParkScreen() {
            if (!this.elements.parkScreen) {
              console.warn("âš ï¸ Referencia de pantalla solar no disponible");
              return;
            }

            try {
              const component =
                this.elements.parkScreen.components["solar-video-cycler"];
              if (component && component.hide) {
                component.hide();
              } else {
                this.elements.parkScreen.setAttribute("visible", "false");
              }
            } catch (error) {
              console.error("âŒ Error ocultando pantalla solar:", error);
            }
          }

          // Petroleo Screen Control Methods
          showPetroleoScreen() {
            if (!this.elements.petroleoScreen) {
              console.warn(
                "âš ï¸ Referencia de pantalla de petrÃ³leo no disponible"
              );
              return;
            }

            try {
              const component =
                this.elements.petroleoScreen.components[
                  "petroleo-image-cycler"
                ];
              if (component && component.show) {
                component.show();
              } else {
                this.elements.petroleoScreen.setAttribute("visible", "true");
              }
            } catch (error) {
              console.error("âŒ Error mostrando pantalla de petrÃ³leo:", error);
            }
          }

          hidePetroleoScreen() {
            if (!this.elements.petroleoScreen) {
              console.warn(
                "âš ï¸ Referencia de pantalla de petrÃ³leo no disponible"
              );
              return;
            }

            try {
              const component =
                this.elements.petroleoScreen.components[
                  "petroleo-image-cycler"
                ];
              if (component && component.hide) {
                component.hide();
              } else {
                this.elements.petroleoScreen.setAttribute("visible", "false");
              }
            } catch (error) {
              console.error("âŒ Error ocultando pantalla de petrÃ³leo:", error);
            }
          }

          // Plataforma Screen Control Methods
          showPlataformaScreen() {
            if (!this.elements.plataformaScreen) {
              console.warn(
                "âš ï¸ Referencia de pantalla de plataformas no disponible"
              );
              return;
            }

            try {
              const component =
                this.elements.plataformaScreen.components[
                  "plataforma-image-cycler"
                ];
              if (component && component.show) {
                component.show();
              } else {
                this.elements.plataformaScreen.setAttribute("visible", "true");
              }
            } catch (error) {
              console.error(
                "âŒ Error mostrando pantalla de plataformas:",
                error
              );
            }
          }

          hidePlataformaScreen() {
            if (!this.elements.plataformaScreen) {
              console.warn(
                "âš ï¸ Referencia de pantalla de plataformas no disponible"
              );
              return;
            }

            try {
              const component =
                this.elements.plataformaScreen.components[
                  "plataforma-image-cycler"
                ];
              if (component && component.hide) {
                component.hide();
              } else {
                this.elements.plataformaScreen.setAttribute("visible", "false");
              }
            } catch (error) {
              console.error(
                "âŒ Error ocultando pantalla de plataformas:",
                error
              );
            }
          }

          // CPF Screen Control Methods
          showCpfScreen() {
            if (!this.elements.cpfScreen) {
              console.warn("âš ï¸ Referencia de pantalla de CPF no disponible");
              return;
            }

            try {
              const component =
                this.elements.cpfScreen.components["cpf-image-cycler"];
              if (component && component.show) {
                component.show();
              } else {
                this.elements.cpfScreen.setAttribute("visible", "true");
              }
            } catch (error) {
              console.error("âŒ Error mostrando pantalla de CPF:", error);
            }
          }

          hideCpfScreen() {
            if (!this.elements.cpfScreen) {
              console.warn("âš ï¸ Referencia de pantalla de CPF no disponible");
              return;
            }

            try {
              const component =
                this.elements.cpfScreen.components["cpf-image-cycler"];
              if (component && component.hide) {
                component.hide();
              } else {
                this.elements.cpfScreen.setAttribute("visible", "false");
              }
            } catch (error) {
              console.error("âŒ Error ocultando pantalla de CPF:", error);
            }
          }

          showLoadingOverlay() {
            this.elements.overlay.setAttribute("visible", "true");
            this.elements.overlay.setAttribute("material", "opacity", 0.8);
          }

          hideLoadingOverlay() {
            this.elements.overlay.setAttribute("visible", "false");
            this.elements.overlay.setAttribute("material", "opacity", 0);
          }
        }

        // Initialize WebSocket client after DOM loads
        document.addEventListener("DOMContentLoaded", function () {
          // Initialize Scene Manager
          sceneManager = new VRSceneManager();

          // Determine server URL based on current host
          const currentHost = window.location.hostname;
          const protocol =
            window.location.protocol === "https:" ? "wss:" : "ws:";
          const serverPort =
            window.location.protocol === "https:" ? "8081" : "8081";
          const serverUrl = `${protocol}//${currentHost}:${serverPort}/ws`;

          console.log("ðŸ”— Conectando al servidor WebSocket:", serverUrl);

          // Initialize WebSocket client
          vrClient = new VRWebSocketClient({
            serverUrl: serverUrl,
            deviceId: `clientevanilla-${Date.now()}`,
            onConnect: () => {
              console.log("ðŸŽ® VR Client connected to server");
              console.log("ðŸ” Current scene ID on connect:", currentSceneId);
              // Send ready signal for current scene
              setTimeout(() => {
                console.log(
                  "ðŸ“¤ Sending READY signal for scene:",
                  currentSceneId
                );
                vrClient.sendReady(currentSceneId);
              }, 1000);
            },
            onDisconnect: () => {
              console.log("ðŸ”Œ VR Client disconnected from server");
            },
            onCommand: (command) => {
              console.log("ðŸ“¨ Received command from server:", command);
              handleServerCommand(command);
            },
            onError: (error) => {
              console.error("ðŸš¨ VR Client error:", error);
            },
          });

          // Connect to server
          vrClient.connect();

          // Add event listeners for user interaction to enable audio
          const enableAudioOnInteraction = () => {
            if (!audioEnabled) {
              enableAudio().then(() => {
                if (audioEnabled && sceneManager && sceneManager.currentScene) {
                  // Try to start audio for current scene
                  sceneManager.updateAudio(sceneManager.currentScene);
                }
              });
            }
          };

          // Listen for various user interactions
          document.addEventListener('click', enableAudioOnInteraction, { once: true });
          document.addEventListener('touchstart', enableAudioOnInteraction, { once: true });
          document.addEventListener('keydown', enableAudioOnInteraction, { once: true });

          function sendStateUpdate() {
            // Send state update to server
            if (vrClient && vrClient.isConnected) {
              vrClient.sendState(currentSceneId, 0, true, 100);
            }
          }

          function handleServerCommand(command) {
            switch (command.commandType) {
              case "LOAD":
                const newSceneId = command.sceneId;
                console.log("ðŸŽ¬ Cargando escena desde servidor:", newSceneId);

                // Load the scene using scene manager
                if (sceneManager) {
                  sceneManager
                    .loadScene(newSceneId)
                    .then((success) => {
                      if (success) {
                        console.log("âœ… Escena cargada desde dashboard");
                      } else {
                        console.error("âŒ Failed to load scene from dashboard");
                      }
                    })
                    .catch((error) => {
                      console.error("ðŸ’¥ Error in loadScene promise:", error);
                    });
                } else {
                  console.error("âŒ Scene manager not initialized");
                }
                break;

              case "START_AT":
                console.log("â–¶ï¸ Iniciando experiencia VR");
                // Start the experience
                break;

              case "PAUSE":
                console.log("â¸ï¸ Pausando experiencia VR");
                // Pause audio and timeline
                const audioEl = document.querySelector("#scene-sound");
                if (audioEl) {
                  audioEl.components.sound.pauseSound();
                }
                break;

              case "RESUME":
                console.log("â–¶ï¸ Reanudando experiencia VR");
                // Resume audio and timeline
                const resumeAudioEl = document.querySelector("#scene-sound");
                if (resumeAudioEl) {
                  resumeAudioEl.components.sound.playSound();
                }
                break;

              case "SEEK":
                console.log("â­ï¸ Seeking command received");
                // No timeline to seek anymore
                break;

              case "SHOW_SCREEN":
                handleShowScreenCommand(command.screenType);
                break;

              case "HIDE_SCREEN":
                handleHideScreenCommand(command.screenType);
                break;

              case "HIDE_ALL_SCREENS":
                handleHideAllScreensCommand();
                break;

              case "SHOW_ALL_SCREENS":
                handleShowAllScreensCommand();
                break;

              case "TOGGLE_SCREEN":
                handleToggleScreenCommand(command.screenType);
                break;

              default:
                console.log("ðŸ¤· Unknown command:", command.commandType);
            }
          }

          // Screen control command handlers
          function handleShowScreenCommand(screenType) {
            if (!sceneManager) {
              console.warn("âš ï¸ SceneManager no disponible");
              return;
            }

            switch (screenType) {
              case "solar":
                sceneManager.showParkScreen();
                break;
              case "petroleo":
                sceneManager.showPetroleoScreen();
                break;
              case "plataforma":
                sceneManager.showPlataformaScreen();
                break;
              case "cpf":
                sceneManager.showCpfScreen();
                break;
              default:
                console.warn("âš ï¸ Tipo de pantalla no reconocido:", screenType);
            }
          }

          function handleHideScreenCommand(screenType) {
            if (!sceneManager) {
              console.warn("âš ï¸ SceneManager no disponible");
              return;
            }

            switch (screenType) {
              case "solar":
                sceneManager.hideParkScreen();
                break;
              case "petroleo":
                sceneManager.hidePetroleoScreen();
                break;
              case "plataforma":
                sceneManager.hidePlataformaScreen();
                break;
              case "cpf":
                sceneManager.hideCpfScreen();
                break;
              default:
                console.warn("âš ï¸ Tipo de pantalla no reconocido:", screenType);
            }
          }

          function handleHideAllScreensCommand() {
            if (!sceneManager) {
              console.warn("âš ï¸ SceneManager no disponible");
              return;
            }

            sceneManager.hideParkScreen();
            sceneManager.hidePetroleoScreen();
            sceneManager.hidePlataformaScreen();
            sceneManager.hideCpfScreen();
          }

          function handleShowAllScreensCommand() {
            if (!sceneManager) {
              console.warn("âš ï¸ SceneManager no disponible");
              return;
            }

            // Mostrar solo las pantallas correspondientes a la escena actual
            switch (currentSceneId) {
              case "escena-1":
                sceneManager.showParkScreen();
                break;
              case "escena-2":
                sceneManager.showPetroleoScreen();
                break;
              case "escena-3":
                sceneManager.showPlataformaScreen();
                sceneManager.showCpfScreen();
                break;
              default:
            }
          }

          function handleToggleScreenCommand(screenType) {
            if (!sceneManager) {
              console.warn("âš ï¸ SceneManager no disponible");
              return;
            }

            switch (screenType) {
              case "solar":
                const parkScreen = document.querySelector("#park-screen");
                if (
                  parkScreen &&
                  parkScreen.getAttribute("visible") === "true"
                ) {
                  sceneManager.hideParkScreen();
                } else {
                  sceneManager.showParkScreen();
                }
                break;
              case "petroleo":
                const petroleoScreen =
                  document.querySelector("#petroleo-screen");
                if (
                  petroleoScreen &&
                  petroleoScreen.getAttribute("visible") === "true"
                ) {
                  sceneManager.hidePetroleoScreen();
                } else {
                  sceneManager.showPetroleoScreen();
                }
                break;
              case "plataforma":
                const plataformaScreen =
                  document.querySelector("#plataforma-screen");
                if (
                  plataformaScreen &&
                  plataformaScreen.getAttribute("visible") === "true"
                ) {
                  sceneManager.hidePlataformaScreen();
                } else {
                  sceneManager.showPlataformaScreen();
                }
                break;
              case "cpf":
                const cpfScreen = document.querySelector("#cpf-screen");
                if (cpfScreen && cpfScreen.getAttribute("visible") === "true") {
                  sceneManager.hideCpfScreen();
                } else {
                  sceneManager.showCpfScreen();
                }
                break;
              default:
                console.warn("âš ï¸ Tipo de pantalla no reconocido:", screenType);
            }
          }

          // Expose to global scope for debugging
          window.vrClient = vrClient;
          window.sceneManager = sceneManager;
          window.handleServerCommand = handleServerCommand;
          window.SCENES_CONFIG = SCENES_CONFIG;

          // Expose screen command handlers for testing
          window.handleShowScreenCommand = handleShowScreenCommand;
          window.handleHideScreenCommand = handleHideScreenCommand;
          window.handleHideAllScreensCommand = handleHideAllScreensCommand;
          window.handleShowAllScreensCommand = handleShowAllScreensCommand;
          window.handleToggleScreenCommand = handleToggleScreenCommand;

          // Expose screen controls globally for debugging
          window.solarScreen = {
            show: () => sceneManager.showParkScreen(),
            hide: () => sceneManager.hideParkScreen(),
            move: (x, y, z) => {
              const parkScreen = document.querySelector("#park-screen");
              if (parkScreen) {
                parkScreen.setAttribute("position", `${x} ${y} ${z}`);
              }
            },
            rotate: (x, y, z) => {
              const parkScreen = document.querySelector("#park-screen");
              if (parkScreen) {
                parkScreen.setAttribute("rotation", `${x} ${y} ${z}`);
              }
            },
            resize: (width, height) => {
              const parkScreen = document.querySelector("#park-screen");
              if (parkScreen) {
                parkScreen.setAttribute("width", width.toString());
                parkScreen.setAttribute("height", height.toString());
              }
            },
            nextVideo: () => {
              const cycler = window.solarVideoCycler;
              if (cycler && cycler.nextVideo) {
                cycler.nextVideo();
              }
            },
            setVideo: (index) => {
              const cycler = window.solarVideoCycler;
              if (cycler && cycler.setVideo) {
                cycler.setVideo(index);
              }
            },
            pause: () => {
              const cycler = window.solarVideoCycler;
              if (cycler && cycler.currentVideo) {
                cycler.currentVideo.pause();
              }
            },
            play: () => {
              const cycler = window.solarVideoCycler;
              if (cycler && cycler.currentVideo) {
                cycler.currentVideo.play();
              }
            },
            info: () => {
              const parkScreen = document.querySelector("#park-screen");
              if (!parkScreen) return null;
              const cycler = window.solarVideoCycler;
              return {
                visible: parkScreen.getAttribute("visible") === "true",
                position: parkScreen.getAttribute("position"),
                rotation: parkScreen.getAttribute("rotation"),
                size: {
                  width: parkScreen.getAttribute("width"),
                  height: parkScreen.getAttribute("height"),
                },
                currentVideo: cycler ? cycler.currentVideoIndex + 1 : 0,
                totalVideos: cycler ? cycler.videos.length : 0,
                playing:
                  cycler && cycler.currentVideo
                    ? !cycler.currentVideo.paused
                    : false,
                currentTime:
                  cycler && cycler.currentVideo
                    ? cycler.currentVideo.currentTime
                    : 0,
                duration:
                  cycler && cycler.currentVideo
                    ? cycler.currentVideo.duration
                    : 0,
              };
            },
            debug: () => {
              const parkScreen = document.querySelector("#park-screen");
              if (!parkScreen) return;
              const cycler = window.solarVideoCycler;
              return {
                visible: parkScreen.getAttribute("visible"),
                position: parkScreen.getAttribute("position"),
                rotation: parkScreen.getAttribute("rotation"),
                size: `${parkScreen.getAttribute("width")}x${parkScreen.getAttribute("height")}`,
                currentVideo: cycler ? cycler.currentVideoIndex + 1 : 0,
                totalVideos: cycler ? cycler.videos.length : 0,
                playing:
                  cycler && cycler.currentVideo
                    ? !cycler.currentVideo.paused
                    : false,
              };
            },
          };

          // Petroleo Screen Controls
          window.petroleoScreen = {
            show: () => sceneManager.showPetroleoScreen(),
            hide: () => sceneManager.hidePetroleoScreen(),
            move: (x, y, z) => {
              const petroleoScreen = document.querySelector("#petroleo-screen");
              if (petroleoScreen) {
                petroleoScreen.setAttribute("position", `${x} ${y} ${z}`);
              }
            },
            rotate: (x, y, z) => {
              const petroleoScreen = document.querySelector("#petroleo-screen");
              if (petroleoScreen) {
                petroleoScreen.setAttribute("rotation", `${x} ${y} ${z}`);
              }
            },
            resize: (width, height) => {
              const petroleoScreen = document.querySelector("#petroleo-screen");
              if (petroleoScreen) {
                petroleoScreen.setAttribute("width", width.toString());
                petroleoScreen.setAttribute("height", height.toString());
              }
            },
            nextImage: () => {
              const cycler = window.petroleoImageCycler;
              if (cycler && cycler.nextImage) {
                cycler.nextImage();
              }
            },
            setImage: (index) => {
              const cycler = window.petroleoImageCycler;
              if (cycler && cycler.setImage) {
                cycler.setImage(index);
              }
            },
            info: () => {
              const petroleoScreen = document.querySelector("#petroleo-screen");
              if (!petroleoScreen) return null;
              const cycler = window.petroleoImageCycler;
              return {
                visible: petroleoScreen.getAttribute("visible") === "true",
                position: petroleoScreen.getAttribute("position"),
                rotation: petroleoScreen.getAttribute("rotation"),
                size: {
                  width: petroleoScreen.getAttribute("width"),
                  height: petroleoScreen.getAttribute("height"),
                },
                currentImage: cycler ? cycler.currentImageIndex + 1 : 0,
                totalImages: cycler ? cycler.images.length : 0,
              };
            },
          };

          // Plataforma Screen Controls
          window.plataformaScreen = {
            show: () => sceneManager.showPlataformaScreen(),
            hide: () => sceneManager.hidePlataformaScreen(),
            move: (x, y, z) => {
              const plataformaScreen =
                document.querySelector("#plataforma-screen");
              if (plataformaScreen) {
                plataformaScreen.setAttribute("position", `${x} ${y} ${z}`);
              }
            },
            rotate: (x, y, z) => {
              const plataformaScreen =
                document.querySelector("#plataforma-screen");
              if (plataformaScreen) {
                plataformaScreen.setAttribute("rotation", `${x} ${y} ${z}`);
              }
            },
            resize: (width, height) => {
              const plataformaScreen =
                document.querySelector("#plataforma-screen");
              if (plataformaScreen) {
                plataformaScreen.setAttribute("width", width.toString());
                plataformaScreen.setAttribute("height", height.toString());
              }
            },
            nextImage: () => {
              const cycler = window.plataformaImageCycler;
              if (cycler && cycler.nextImage) {
                cycler.nextImage();
              }
            },
            setImage: (index) => {
              const cycler = window.plataformaImageCycler;
              if (cycler && cycler.setImage) {
                cycler.setImage(index);
              }
            },
            info: () => {
              const plataformaScreen =
                document.querySelector("#plataforma-screen");
              if (!plataformaScreen) return null;
              const cycler = window.plataformaImageCycler;
              return {
                visible: plataformaScreen.getAttribute("visible") === "true",
                position: plataformaScreen.getAttribute("position"),
                rotation: plataformaScreen.getAttribute("rotation"),
                size: {
                  width: plataformaScreen.getAttribute("width"),
                  height: plataformaScreen.getAttribute("height"),
                },
                currentImage: cycler ? cycler.currentImageIndex + 1 : 0,
                totalImages: cycler ? cycler.images.length : 0,
              };
            },
          };

          // CPF Screen Controls
          window.cpfScreen = {
            show: () => sceneManager.showCpfScreen(),
            hide: () => sceneManager.hideCpfScreen(),
            move: (x, y, z) => {
              const cpfScreen = document.querySelector("#cpf-screen");
              if (cpfScreen) {
                cpfScreen.setAttribute("position", `${x} ${y} ${z}`);
              }
            },
            rotate: (x, y, z) => {
              const cpfScreen = document.querySelector("#cpf-screen");
              if (cpfScreen) {
                cpfScreen.setAttribute("rotation", `${x} ${y} ${z}`);
              }
            },
            resize: (width, height) => {
              const cpfScreen = document.querySelector("#cpf-screen");
              if (cpfScreen) {
                cpfScreen.setAttribute("width", width.toString());
                cpfScreen.setAttribute("height", height.toString());
              }
            },
            nextImage: () => {
              const cycler = window.cpfImageCycler;
              if (cycler && cycler.nextImage) {
                cycler.nextImage();
              }
            },
            setImage: (index) => {
              const cycler = window.cpfImageCycler;
              if (cycler && cycler.setImage) {
                cycler.setImage(index);
              }
            },
            info: () => {
              const cpfScreen = document.querySelector("#cpf-screen");
              if (!cpfScreen) return null;
              const cycler = window.cpfImageCycler;
              return {
                visible: cpfScreen.getAttribute("visible") === "true",
                position: cpfScreen.getAttribute("position"),
                rotation: cpfScreen.getAttribute("rotation"),
                size: {
                  width: cpfScreen.getAttribute("width"),
                  height: cpfScreen.getAttribute("height"),
                },
                currentImage: cycler ? cycler.currentImageIndex + 1 : 0,
                totalImages: cycler ? cycler.images.length : 0,
              };
            },
          };

          // Test scene loading functions for development
          window.loadScene = (sceneId) => {
            if (sceneManager) {
              return sceneManager.loadScene(sceneId);
            } else {
              console.error("Scene manager not initialized");
              return false;
            }
          };

          console.log("ðŸŽ® VR Scene Controls Available:");
          console.log(
            '  loadScene("escena-1") - Load EnergÃ­as Renovables scene'
          );
          console.log(
            '  loadScene("escena-2") - Load Operaciones Petroleras scene'
          );
          console.log(
            '  loadScene("escena-3") - Load Operaciones de Plataforma scene'
          );
          console.log('  loadScene("escena-4") - Load Entorno Natural scene');
          console.log('  loadScene("escena-5") - Load Vista PanorÃ¡mica scene');
          console.log(
            '  loadScene("escena-7") - Load Vista Industrial Avanzada scene'
          );
          console.log(
            '  loadScene("escena-8") - Load Operaciones Industriales scene'
          );
          console.log(
            '  loadScene("escena-9") - Load Instalaciones Avanzadas scene'
          );
          console.log(
            '  loadScene("escena-10") - Load Operaciones Especializadas scene'
          );
          console.log(
            '  loadScene("escena-11") - Load Infraestructura Completa scene'
          );
          console.log("  toggleScene() - Toggle between scenes manually");

          console.log("ðŸŽ® Screen Command Controls Available:");
          console.log('  handleShowScreenCommand("solar") - Show solar screen');
          console.log(
            '  handleShowScreenCommand("petroleo") - Show petroleo screen'
          );
          console.log(
            '  handleShowScreenCommand("plataforma") - Show plataforma screen'
          );
          console.log('  handleShowScreenCommand("cpf") - Show CPF screen');
          console.log('  handleHideScreenCommand("solar") - Hide solar screen');
          console.log(
            '  handleHideScreenCommand("petroleo") - Hide petroleo screen'
          );
          console.log(
            '  handleHideScreenCommand("plataforma") - Hide plataforma screen'
          );
          console.log('  handleHideScreenCommand("cpf") - Hide CPF screen');
          console.log("  handleHideAllScreensCommand() - Hide all screens");
          console.log(
            "  handleShowAllScreensCommand() - Show screens for current scene"
          );
          console.log(
            '  handleToggleScreenCommand("solar") - Toggle solar screen'
          );
          console.log(
            '  handleToggleScreenCommand("petroleo") - Toggle petroleo screen'
          );
          console.log(
            '  handleToggleScreenCommand("plataforma") - Toggle plataforma screen'
          );
          console.log('  handleToggleScreenCommand("cpf") - Toggle CPF screen');

          console.log("ðŸŽ® Solar Screen Controls Available:");
          console.log("  solarScreen.show() - Show solar floating screen");
          console.log("  solarScreen.hide() - Hide solar floating screen");
          console.log(
            "  solarScreen.move(x, y, z) - Move solar screen to position"
          );
          console.log("  solarScreen.rotate(x, y, z) - Rotate solar screen");
          console.log(
            "  solarScreen.resize(width, height) - Resize solar screen"
          );
          console.log("  solarScreen.nextVideo() - Play next solar video");
          console.log(
            "  solarScreen.setVideo(index) - Set specific video (0-2)"
          );
          console.log("  solarScreen.pause() - Pause current video");
          console.log("  solarScreen.play() - Resume current video");
          console.log("  solarScreen.info() - Get screen information");
          console.log(
            "  solarScreen.debug() - Debug screen position and state"
          );

          console.log("ðŸŽ® Petroleo Screen Controls Available:");
          console.log(
            "  petroleoScreen.show() - Show petroleo floating screen"
          );
          console.log(
            "  petroleoScreen.hide() - Hide petroleo floating screen"
          );
          console.log(
            "  petroleoScreen.move(x, y, z) - Move petroleo screen to position"
          );
          console.log(
            "  petroleoScreen.rotate(x, y, z) - Rotate petroleo screen"
          );
          console.log(
            "  petroleoScreen.resize(width, height) - Resize petroleo screen"
          );
          console.log(
            "  petroleoScreen.nextImage() - Show next petroleo image"
          );
          console.log(
            "  petroleoScreen.setImage(index) - Set specific image (0-2)"
          );
          console.log("  petroleoScreen.info() - Get screen information");

          console.log("ðŸŽ® Plataforma Screen Controls Available:");
          console.log(
            "  plataformaScreen.show() - Show plataforma floating screen"
          );
          console.log(
            "  plataformaScreen.hide() - Hide plataforma floating screen"
          );
          console.log(
            "  plataformaScreen.move(x, y, z) - Move plataforma screen to position"
          );
          console.log(
            "  plataformaScreen.rotate(x, y, z) - Rotate plataforma screen"
          );
          console.log(
            "  plataformaScreen.resize(width, height) - Resize plataforma screen"
          );
          console.log(
            "  plataformaScreen.nextImage() - Show next plataforma image"
          );
          console.log(
            "  plataformaScreen.setImage(index) - Set specific image (0-2)"
          );
          console.log("  plataformaScreen.info() - Get screen information");

          console.log("ðŸŽ® CPF Screen Controls Available:");
          console.log("  cpfScreen.show() - Show CPF floating screen");
          console.log("  cpfScreen.hide() - Hide CPF floating screen");
          console.log(
            "  cpfScreen.move(x, y, z) - Move CPF screen to position"
          );
          console.log("  cpfScreen.rotate(x, y, z) - Rotate CPF screen");
          console.log("  cpfScreen.resize(width, height) - Resize CPF screen");
          console.log("  cpfScreen.nextImage() - Show next CPF image");
          console.log("  cpfScreen.setImage(index) - Set specific image (0-2)");
          console.log("  cpfScreen.info() - Get screen information");

          // Add a simple scene toggle function
          window.toggleScene = () => {
            if (sceneManager) {
              let newScene;
              if (currentSceneId === "base") {
                newScene = "escena-1";
              } else if (currentSceneId === "escena-1") {
                newScene = "escena-2";
              } else if (currentSceneId === "escena-2") {
                newScene = "escena-3";
              } else if (currentSceneId === "escena-3") {
                newScene = "escena-4";
              } else if (currentSceneId === "escena-4") {
                newScene = "escena-5";
              } else if (currentSceneId === "escena-5") {
                newScene = "escena-7";
              } else if (currentSceneId === "escena-7") {
                newScene = "escena-8";
              } else if (currentSceneId === "escena-8") {
                newScene = "escena-9";
              } else if (currentSceneId === "escena-9") {
                newScene = "escena-10";
              } else if (currentSceneId === "escena-10") {
                newScene = "escena-11";
              } else {
                newScene = "base";
              }
              sceneManager.loadScene(newScene);
            }
          };
        });
      </script>
    </a-scene>
  </body>
</html>
